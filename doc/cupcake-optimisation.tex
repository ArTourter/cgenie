%% CURRENT STATUS:
%%
%%  Atmospheric tracers mostly done: the remaining thing to do before
%%  going onto the sediment tracers are the BIOGEM forcing arrays.

\documentclass[a4paper,10pt,article]{memoir}

\usepackage[a4paper,margin=1in]{geometry}

\usepackage[utf8]{inputenc}
\usepackage{fourier}
\usepackage{amsmath,amssymb}

\usepackage{color}
\definecolor{orange}{rgb}{0.75,0.5,0}
\definecolor{magenta}{rgb}{1,0,1}
\definecolor{cyan}{rgb}{0,1,1}
\definecolor{grey}{rgb}{0.25,0.25,0.25}
\newcommand{\outline}[1]{{\color{grey}{\scriptsize #1}}}
\newcommand{\revnote}[1]{{\color{red}\textit{\textbf{#1}}}}
\newcommand{\note}[1]{{\color{blue}\textit{\textbf{#1}}}}
\newcommand{\citenote}[1]{{\color{orange}{[\textit{\textbf{#1}}]}}}

\usepackage{xspace}

\usepackage{listings}
\usepackage{courier}
\lstset{basicstyle=\tiny\ttfamily,breaklines=true,language=Python}

\usepackage{fancyvrb}
\usepackage{url}

\usepackage{float}
\newfloat{listing}{tbp}{lop}
\floatname{listing}{Listing}

\title{Optimisation work for GENIE \texttt{cupcake}}
\author{Ian~Ross}
\date{2 April 2015}

\begin{document}

\catcode`~=11    % Make tilde a normal character (danger of weirdness...)
%\catcode`~=13    % Make tilde an active character again

\maketitle

\textbf{Not yet done:}
\begin{itemize}
  \item{Tracer reorganisation}
  \item{BIOGEM array-to-vector reorganisation}
\end{itemize}

%======================================================================
\chapter{``Everything allocatable''}

General guidelines:
\begin{enumerate}
  \item{Rationalise coordinate dimension size variables before doing
    anything else -- all this \texttt{maxi} vs. \texttt{imax} stuff is
    just confusing and unnecessary.}
  \item{Convert arrays to \texttt{ALLOCATABLE} in small groups and do
    a little test to make sure you're not screwing things up!}
  \item{Initialise all allocated arrays to zero: the original
    fixed-size arrays are mostly defined as \texttt{SAVE} and there
    are some places that seem to rely on them being zeroed.}
  \item{Be careful about using the \texttt{maxi} and \texttt{maxj}
    coordinate dimensions before they're properly initialised!  This
    is especially possible in the various \texttt{initialise\_...}
    routines.}
  \item{Some modules haven't been fully organised as F90 modules, so
    that also needs to be done: mostly it's a matter of putting the
    initialisation, step and tear-down routines into a single module.}
\end{enumerate}

%----------------------------------------------------------------------
\section{\texttt{gemlite}}

These need to be redefined \emph{not} to be \texttt{PARAMETER}s:

\begin{verbatim}
  INTEGER,PARAMETER::n_i = ilon1_ocn
  INTEGER,PARAMETER::n_j = ilat1_ocn
  INTEGER,PARAMETER::n_k = inl1_ocn
\end{verbatim}

Most are already \texttt{ALLOCATABLE}, except for:

\begin{verbatim}
  INTEGER,DIMENSION(n_i,n_j)::goldstein_k1
  REAL,DIMENSION(n_k)::goldstein_dz
  REAL,DIMENSION(n_k)::goldstein_dza
  REAL,DIMENSION(0:n_j)::goldstein_sv
\end{verbatim}

\begin{itemize}
  \item{Needed to set up \texttt{gemlite} as a proper F90 module in
    order to have calling interfaces that will work with assumed-shape
    arrays.}
  \item{Tracer counts!  (Probably like more or less all the other
    biogeochemistry modules.)}
\end{itemize}

The \texttt{maxisles} variable is used in the following allocations:

\begin{verbatim}
    ALLOCATE(lpisl(mpi,maxisles))   ; lpisl = 0
    ALLOCATE(ipisl(mpi,maxisles))   ; ipisl = 0
    ALLOCATE(jpisl(mpi,maxisles))   ; jpisl = 0
    ALLOCATE(npi(maxisles))         ; npi = 0
    ALLOCATE(psisl(0:maxi,0:maxj,maxisles))          ; psisl = 0.0
    ALLOCATE(ubisl(2,0:maxi+1,0:maxj,maxisles))      ; ubisl = 0.0
    ALLOCATE(erisl(maxisles,maxisles+1))             ; erisl = 0.0
    ALLOCATE(psibc(maxisles))                        ; psibc = 0.0
\end{verbatim}

All now allocated to the exact number of islands.

%----------------------------------------------------------------------
\section{\texttt{goldsteinseaice}}

These need to be redefined \emph{not} to be \texttt{PARAMETER}s:

\begin{verbatim}
  INTEGER, PARAMETER :: maxi = GOLDSTEINNLONS
  INTEGER, PARAMETER :: maxj = GOLDSTEINNLATS
  INTEGER, PARAMETER :: maxk = GOLDSTEINNLEVS
\end{verbatim}

All defined in \texttt{gold\_seaice\_lib.f90}; all need to be made
\texttt{ALLOCATABLE}:

\begin{verbatim}
  INTEGER :: k1(0:maxi+1,0:maxj+1)
  REAL, DIMENSION(0:maxj) :: s, c, sv, cv
  REAL :: ds(maxj), dsv(1:maxj-1), rds2(2:maxj-1), u(2,0:maxi,0:maxj)
  REAL, DIMENSION(0:maxj) :: rc, rcv, cv2, rc2
  REAL :: rds(maxj), rdsv(1:maxj-1)
  REAL, DIMENSION(maxj) :: asurf
  REAL, DIMENSION(2,maxi,maxj) :: varice, varice1, dtha, varicedy, variceth
  REAL, DIMENSION(maxi,maxj) :: tice, albice
  REAL, DIMENSION(2,maxi,maxj) :: haavg, dthaavg
  REAL, DIMENSION(maxi,maxj) :: ticeavg, albiceavg, fxdelavg ,fwdelavg
\end{verbatim}

as do the following from \texttt{gold\_seaice\_netcdf.f90}:

\begin{verbatim}
  REAL, DIMENSION(maxi) :: nclon1, nclon2, nclon3
  REAL, DIMENSION(maxj) :: nclat1, nclat2, nclat3
\end{verbatim}

Need to be careful not to use coordinate size variables in subroutine
argument definitions \emph{before they're assigned values!}  The
Fortran compiler doesn't help you to spot this, so it produces weird
run-time errors.

%----------------------------------------------------------------------
\section{\texttt{ents}}

Same as in other modules:

\begin{verbatim}
  INTEGER, PARAMETER :: maxi=GOLDSTEINNLONS, maxj=GOLDSTEINNLATS
\end{verbatim}

(Also the usual \texttt{maxi}/\texttt{imax},
\texttt{maxj}/\texttt{jmax} duplication.)

All defined in \texttt{gold\_seaice\_lib.f90}; all need to be made
\texttt{ALLOCATABLE}:

\begin{verbatim}
  INTEGER :: ents_k1(maxi,maxj)
  REAL :: ents_lat(maxj)
  REAL, DIMENSION(maxi,maxj) :: Cveg, Csoil, fv, epsv
  REAL, DIMENSION(maxi,maxj) :: leaf, respveg, respsoil, photo
  REAL, DIMENSION(maxi,maxj) :: sphoto, srveg, sleaf, srsoil, sCveg1, &
    & sCsoil1, sfv1, sepsv1, sfx0a, sfx0o, sfxsens, sfxlw, sevap, &
    & spptn, srelh, sbcap, salbs, ssnow, sz0
  REAL :: stqld(2,maxi,maxj)
  REAL, DIMENSION(2,maxi,maxj) :: tqld, tqldavg
  REAL, DIMENSION(maxi,maxj) :: bcap, bcapavg, snowavg, z0avg, &
    albsavg, z0, evapavg, pptnavg, runavg, fvfv
  REAL :: fxavg(7,maxi,maxj)
\end{verbatim}

Some cases where initialisation is really needed: all the fixed-size
arrays were defined as \texttt{SAVE} so they got initialised
automatically.

%----------------------------------------------------------------------
\section{\texttt{embm}}

\begin{verbatim}
  INTEGER, PARAMETER :: maxi=GOLDSTEINNLONS, maxj=GOLDSTEINNLATS
  INTEGER, PARAMETER :: maxk=GOLDSTEINNLEVS, maxl=2
  INTEGER, PARAMETER :: maxnyr=400
  INTEGER, PARAMETER :: en_ntimes_max=2000
\end{verbatim}

Here, \texttt{maxl} isn't used, but these \texttt{maxnyr} and
\texttt{en\_ntimes\_max} things will require some attention.

\begin{verbatim}
  INTEGER :: k1(0:maxi+1,0:maxj+1)
  INTEGER :: ku(2,maxi,maxj), mk(maxi+1,maxj)
  REAL :: dt(maxk), ds(maxj), dsv(1:maxj-1), rds2(2:maxj-1), &
       & dz(maxk), s(0:maxj), c(0:maxj), dzu(2,maxk), &
       & tau(2,maxi,maxj), drag(2,maxi+1,maxj), dztau(2,maxi,maxj), &
       & diff(2), ec(4), sv(0:maxj)
  REAL :: cv(0:maxj), dza(maxk), dztav(2,maxi,maxj), &
       & tau0(maxi,maxj), dztav0(maxi,maxj), &
       & tau1(maxi,maxj), dztav1(maxi,maxj), tsa0(maxj)
  REAL :: rc(0:maxj), rcv(1:maxj-1), rdphi, rds(maxj), rdsv(1:maxj-1), &
       & cv2(1:maxj-1), rc2(0:maxj), rtv(maxi,maxj), rtv3(maxi,maxj), &
       & rdz(maxk), rdza(maxk)
  REAL :: us_dztau(2, maxi, maxj), us_dztav(2, maxi, maxj)
  REAL :: asurf(maxj)
  REAL :: tq(2,maxi,maxj), tq1(2,maxi,maxj), qsata(maxi,maxj), &
       & qsato(maxi,maxj), co2(maxi,maxj), ch4(maxi,maxj), n2o(maxi,maxj), &
       & varice(2,maxi,maxj), varice1(2,maxi,maxj), &
       & tqa(2,maxi,maxj), solfor(maxj,maxnyr)
  REAL :: albcl(maxi,maxj), fxsw(maxi,maxj), fxplw(maxi,maxj), &
       & fx0a(maxi,maxj), fx0o(maxi,maxj), fxsen(maxi,maxj), &
       & pmeadj(maxi,maxj), pptn(maxi,maxj), evap(maxi,maxj), &
       & usurf(maxi,maxj), fxlata(maxi,maxj), fxlato(maxi,maxj), &
       & fxlw(maxi,maxj), diffa(2,2,maxj), betam(2), betaz(2), hatmbl(2), &
       & ca(maxi,maxj), qb(maxi,maxj), qbsic(maxi,maxj)
  REAL :: fx0sic(maxi,maxj), fx0neto(maxi,maxj), fwfxneto(maxi,maxj), &
       & evapsic(maxi,maxj), tsfreez(maxi,maxj)
  REAL :: uatm(2,maxi,maxj)
  REAL :: tqavg(2,maxi,maxj), fxlatavg(maxi,maxj), fxsenavg(maxi,maxj), &
       & fxswavg(maxi,maxj), fxlwavg(maxi,maxj), fwpptavg(maxi,maxj), &
       & fwevpavg(maxi,maxj)
  REAL :: fx0avg(4,maxi,maxj), fwavg(2,maxi,maxj)
  REAL :: albo(maxj,maxnyr), palb(maxi,maxj), palbavg(maxi,maxj)
  REAL :: lice_vect(maxi,maxj,en_ntimes_max)
  REAL, DIMENSION(maxi,maxj) :: d18o_ice_thresh, d18o_orog_min, d18o_orog_grad
  REAL :: uatml(2,maxi,maxj,maxnyr)
  REAL, DIMENSION(maxi,maxj,maxnyr) :: usurfl, tncep, pncep, rhncep, atm_alb
  REAL, DIMENSION(maxi,maxj) :: chl, cel
  REAL, DIMENSION(maxi,maxj) :: q_pa, rq_pa, q_pa_avg, rq_pa_avg
  INTEGER, DIMENSION(maxi,maxj) :: iroff, jroff
\end{verbatim}

The \texttt{maxnyr} (400) and \texttt{en\_ntimes\_max} (2000) things
are used in the following allocations:

\begin{verbatim}
    ALLOCATE(solfor(maxj,maxnyr))
    ALLOCATE(albo(maxj,maxnyr))
    ALLOCATE(uatml(2,maxi,maxj,maxnyr))
    ALLOCATE(usurfl(maxi,maxj,maxnyr))
    ALLOCATE(tncep(maxi,maxj,maxnyr))
    ALLOCATE(pncep(maxi,maxj,maxnyr))
    ALLOCATE(rhncep(maxi,maxj,maxnyr))
    ALLOCATE(atm_alb(maxi,maxj,maxnyr))

    REAL :: orbitall_vect(en_ntimes_max,5) [local]
    ALLOCATE(orog_vect(maxi,maxj,en_ntimes_max)) ; orog_vect = 0.0
    ALLOCATE(lice_vect(maxi,maxj,en_ntimes_max)) ; lice_vect = 0.0
\end{verbatim}

Now removed and replaced with more appropriate allocations where
required.

%----------------------------------------------------------------------
\section{\texttt{atchem}}

\begin{verbatim}
  INTEGER,PARAMETER::n_i = ilon1_atm
  INTEGER,PARAMETER::n_j = ilat1_atm
  INTEGER,PARAMETER::n_phys_atm = 15
\end{verbatim}

The \texttt{n\_phys\_atm} variable will be dealt with in the
``tracers'' stuff.

\begin{verbatim}
  real,dimension(n_atm,n_i,n_j) :: atm
  real,dimension(n_atm,n_i,n_j) :: fatm
  real,dimension(n_phys_atm,n_i,n_j) :: phys_atm
  real,dimension(n_atm,n_i,n_j) :: atm_slabbiosphere
\end{verbatim}

%----------------------------------------------------------------------
\section{\texttt{rokgem}}

\begin{verbatim}
  INTEGER,PARAMETER :: n_i = ilon1_rok
  INTEGER,PARAMETER :: n_j = ilat1_rok
  INTEGER,PARAMETER :: n_phys_rok = 08
  INTEGER,PARAMETER :: n_phys_ocnrok = 06
  INTEGER,PARAMETER :: n_io = ilon1_rok
  INTEGER,PARAMETER :: n_jo = ilat1_rok
  INTEGER,PARAMETER :: n_ko = inl1_ocn
\end{verbatim}

Some are already \texttt{ALLOCATABLE}...

\begin{verbatim}
  real,dimension(n_phys_rok,n_i,n_j)::phys_rok
  REAL,DIMENSION(n_phys_ocnrok,n_io,n_jo) :: phys_ocnrok
  INTEGER,DIMENSION(ilon1_ocn,ilat1_ocn) :: goldstein_k1
  INTEGER :: landmask(n_i,n_j)
  REAL :: runoff_drainage(n_i+2,n_j+2)
  INTEGER :: runoff_drainto(n_i,n_j,2)
  REAL :: runoff_coast(n_i,n_j)
  REAL :: total_calcium_flux(n_i,n_j)
  REAL :: total_calcium_flux_Ca(n_i,n_j)
  REAL :: total_calcium_flux_Si(n_i,n_j)
  REAL :: weather_fCaCO3_2D(n_i,n_j)
  REAL :: weather_fCaSiO3_2D(n_i,n_j)
  REAL :: orogeny(n_i,n_j)
  REAL :: regimes_calib(n_i,n_j)
  REAL :: ref_T0_2D(n_i,n_j)
  REAL :: ref_R0_2D(n_i,n_j)
  REAL :: ref_P0_2D(n_i,n_j)
  REAL :: data_T_2D(n_i,n_j)
  REAL :: data_R_2D(n_i,n_j)
  REAL :: data_P_2D(n_i,n_j)
  REAL :: calibrate_T_2D(n_i,n_j)
  REAL :: calibrate_R_2D(n_i,n_j)
  REAL :: calibrate_P_2D(n_i,n_j)
\end{verbatim}

%----------------------------------------------------------------------
\section{\texttt{goldstein}}

\begin{verbatim}
  INTEGER, PARAMETER :: maxi=GOLDSTEINNLONS, maxj=GOLDSTEINNLATS
  INTEGER, PARAMETER :: maxk=GOLDSTEINNLEVS, maxl=GOLDSTEINNTRACS
  INTEGER, PARAMETER :: maxnyr=720
  INTEGER, PARAMETER :: mpxi=maxi, mpxj=maxj+1
  INTEGER, PARAMETER :: maxisles=GOLDSTEINMAXISLES, mpi=2 * (maxi + maxj)
\end{verbatim}

\begin{verbatim}
  INTEGER :: k1(0:maxi+1,0:maxj+1), ku(2,maxi,maxj), mk(maxi+1,maxj)
  INTEGER :: ips(maxj), ipf(maxj), ias(maxj), iaf(maxj)
  INTEGER :: lpisl(mpi,maxisles), ipisl(mpi,maxisles), jpisl(mpi,maxisles)
  INTEGER :: npi(maxisles)
  REAL :: dt(maxk), ds(maxj), dsv(1:maxj-1), rds2(2:maxj-1)
  REAL :: dz(maxk), u(3,0:maxi,0:maxj,maxk), ts(maxl,0:maxi+1,0:maxj+1,0:maxk+1)
  REAL :: s(0:maxj), c(0:maxj), dzu(2,maxk), tau(2,maxi,maxj)
  REAL :: drag(2,maxi+1,maxj), dztau(2,maxi,maxj)
  REAL :: ratm(mpxi*mpxj,mpxi+1), ub(2,0:maxi+1,0:maxj)
  REAL :: rho(0:maxi+1,0:maxj+1,0:maxk), ts1(maxl,0:maxi+1,0:maxj+1,0:maxk+1)
  REAL :: sv(0:maxj)
  REAL :: cv(0:maxj), dza(maxk), dztav(2,maxi,maxj), gb(mpxi*mpxj)
  REAL :: gap(mpxi*mpxj,2*mpxi+3), cost(maxi,maxj), rh(3,0:maxi+1,0:maxj+1)
  REAL :: gbold(mpxi*mpxj), tau0(maxi,maxj), dztav0(maxi,maxj)
  REAL :: tau1(maxi,maxj), dztav1(maxi,maxj), tsa0(maxj), t0
  REAL :: fw_hosing(maxi,maxj), rhosing(maxi,maxj), zro(maxk), zw(0:maxk)
  REAL :: dzg(maxk,maxk), z2dzg(maxk,maxk), rdzg(maxk,maxk)
  REAL :: fw_anom(maxi,maxj), fw_anom_rate(maxi,maxj)
  REAL :: psi(0:maxi,0:maxj)
  REAL :: u1(3,0:maxi,0:maxj,maxk)
  REAL, DIMENSION(0:maxj) :: rc, rc2
  REAL, DIMENSION(maxi,maxj) :: rtv, rtv3
  REAL, DIMENSION(1:maxj-1) :: rcv, rdsv, cv2
  REAL :: rds(maxj), rdz(maxk), rdza(maxk)
  REAL :: bp(maxi+1,maxj,maxk), sbp(maxi+1,maxj)
  INTEGER :: icosd(maxi,maxj)
  REAL :: asurf(maxj)
  REAL :: tsavg(maxl,0:maxi+1,0:maxj+1,0:maxk+1)
  REAL :: uavg(3,0:maxi,0:maxj,maxk), rhoavg(0:maxi+1,0:maxj+1,0:maxk)
  REAL :: fx0avg(5,maxi,maxj), fwavg(4,maxi,maxj), windavg(4,maxi,maxj)
  REAL :: psisl(0:maxi,0:maxj,maxisles), ubisl(2,0:maxi+1,0:maxj,maxisles)
  REAL :: erisl(maxisles,maxisles+1), psibc(maxisles)
  REAL :: ts_store(maxl,maxi,maxj,maxk)
  REAL :: albcl(maxi,maxj)
  REAL, DIMENSION(maxi,maxj) :: &
       & evap_save1, late_save1, sens_save1, evap_save2, late_save2, sens_save2
  REAL, DIMENSION(maxi,maxj) :: &
       & mldpebuoy, mldpeconv, mldpelayer1, mldketau, mldemix, mld
  REAL, DIMENSION(maxk) :: mlddec, mlddecd
  INTEGER :: mldk(maxi,maxj)
  REAL :: ediff1(maxi,maxj,maxk-1), diffmax(maxk)
  REAL :: ssmax(maxk-1)
  LOGICAL :: getj(maxi,maxj)
\end{verbatim}

%----------------------------------------------------------------------
\section{\texttt{sedgem}}

Need to merge \texttt{sedgem.f90}, \texttt{initialise\_sedgem.f90} and
\texttt{end\_sedgem.f90}.

\begin{verbatim}
  INTEGER, PARAMETER :: n_i = ilon1_sed
  INTEGER, PARAMETER :: n_j = ilat1_sed
  INTEGER, PARAMETER :: n_phys_sed = 14
  INTEGER, PARAMETER :: n_opt_sed = 26
\end{verbatim}

Almost everything is already allocatable.  Should be pretty easy to
do.

%----------------------------------------------------------------------
\section{\texttt{biogem}}

\begin{verbatim}
  INTEGER,PARAMETER::n_i = ilon1_ocn
  INTEGER,PARAMETER::n_j = ilat1_ocn
  INTEGER,PARAMETER::n_k = inl1_ocn
  INTEGER,PARAMETER::n_phys_ocn = 21
  INTEGER,PARAMETER::n_phys_ocnatm = 25
  INTEGER,PARAMETER::n_data_max = 32767
  INTEGER,PARAMETER::n_opt_misc = 14
  INTEGER,PARAMETER::n_opt_atm = 01
  INTEGER,PARAMETER::n_opt_bio = 06
  INTEGER,PARAMETER::n_opt_force = 08
  INTEGER,PARAMETER::n_opt_data = 30
  INTEGER,PARAMETER::n_opt_select = 05
  INTEGER,PARAMETER::n_diag_bio = 09
  INTEGER,PARAMETER::n_diag_geochem = 07
  INTEGER,PARAMETER::n_diag_misc_2D = 07
\end{verbatim}

Lots of arrays...



%======================================================================
\chapter{Tracer reorganisation}

\subsection*{Tracer counts}

Tracer counts are defined in \texttt{common/gem\_cmn.f90} as
\texttt{PARAMETER}s:
\begin{verbatim}
  INTEGER,PARAMETER::n_atm = 19
  INTEGER,PARAMETER::n_ocn = 95
  INTEGER,PARAMETER::n_sed = 79
\end{verbatim}
and also in \texttt{wrappers/genie\_control.f90}:
\begin{verbatim}
  INTEGER, PARAMETER :: intrac_atm_max=19, intrac_ocn_max=95, intrac_sed_max=79
\end{verbatim}
Instead, these \emph{maximum} tracer counts should be kept as
\texttt{PARAMETER}s while the \emph{actual} tracer counts are
determined from the \texttt{atm\_select}, \texttt{ocn\_select} and
\texttt{sed\_select} arrays:
\begin{verbatim}
  INTEGER, PARAMETER :: &
    & n_atm_max = 19, n_ocn_max = 95, n_sed_max = 79

  ...

  n_atm = COUNT(atm_select)
  n_ocn = COUNT(ocn_select)
  n_sed = COUNT(sed_select)
\end{verbatim}
and index mapping arrays should be defined as:
\begin{verbatim}
  INTEGER, DIMENSION(:), ALLOCATABLE :: &
    & idx_to_atm, idx_to_ocn, idx_to_sed
  INTEGER, DIMENSION(n_atm_max) :: atm_to_idx
  INTEGER, DIMENSION(n_ocn_max) :: ocn_to_idx
  INTEGER, DIMENSION(n_sed_max) :: sed_to_idx
\end{verbatim}
one set giving the mapping from the index into tracer arrays to the
tracer ID (all the existing \texttt{io\_...} constants) and the other
giving the mapping from the tracer ID to the index into tracer arrays
(with a default value of $-1$ for unused tracers).  These things
should all be set up immediately after the main GENIE namelist is read
so that all of the array sizes are assigned before any of the
sub-modules are initialised.

Some of this sort of thing has already been partially done in
\texttt{common/gem\_util.f90} and \texttt{common/gem\_cmn.f90}.  That
stuff should be cleaned up and used for this.  There should be one
common set of tracer index maps for each tracer type (atmosphere,
ocean, sediment) across all modules.



\subsection*{General principles}

The basic procedure will be something like this:
\begin{enumerate}
  \item{Globally rename all \texttt{ia\_...}, \texttt{io\_...},
    \texttt{is\_...} constants to \texttt{ias\_...},
    \texttt{ios\_...}, \texttt{iss\_...} (the ``\texttt{s}'' is for
    ``select'').  From now on, I'll use the atmosphere version of
    these things as a proxy for all three types.}
  \item{TEST}
  \item{Introduce new \texttt{ia\_...}\emph{variables} that will refer
    to the actual locations of these species in the dynamics arrays.
    References to \texttt{atm\_select} will still use the
    \texttt{ias\_...} constant index values.}
  \item{Work out what sort of mapping is needed between the constant
    \texttt{ias\_...} values and the variable \texttt{ia\_...}
    values.}
  \item{Come up with better names for \texttt{n\_atm} and
    \texttt{n\_l\_atm}.}
  \item{Set up tracer counting, \texttt{ia\_...} variable assignment,
    mapping calculations in GENIE initialisation (rework existing code
    in \texttt{gem\_cmn.f90} and \texttt{gem\_util.f90}).}
  \item{TEST}
  \item{Replace all array sizing based on \texttt{n\_atm} by
    \texttt{n\_l\_atm}.  Statically sized arrays all become
    ALLOCATABLE.  Record which arrays these are and check up on each
    use site to make sure that there are no problems (e.g. with slices
    or the whole array being used in a way that won't work any more).}
  \item{Replace indexing into dynamics arrays with \texttt{ia\_...}
    versions.}
  \item{TEST}
  \item{Do the same for the sediment and ocean tracers.  (Do them in
    atmosphere, sediment, ocean order because the number of
    occurrences of \texttt{ia\_...}, \texttt{is\_...} and
    \texttt{io\_...} are respectively 290, 1117 and 2745!}
  \item{Think about replacing \texttt{ipa\_...}, \texttt{ipo\_...} and
    similar indexing schemes with F90 derived types.}
\end{enumerate}

%----------------------------------------------------------------------
\section{Atmospheric tracers}

\subsection{Atmospheric tracer indexing}

\subsubsection{Index variables}

Indexes:
\begin{center}
\begin{tabular}{lcl}
  \textbf{Name} & \textbf{Index} & \\
\texttt{ia\_T}         &  1 & Temperature \\
\texttt{ia\_q}         &  2 & Specific humidity \\
\texttt{ia\_pCO2}      &  3 & $\mathrm{pCO_2}$ \\
\texttt{ia\_pCO2\_13C} &  4 & $\mathrm{^{13}C}$ ($\mathrm{pCO_2}$) \\
\texttt{ia\_pCO2\_14C} &  5 & $\mathrm{^{14}C}$ ($\mathrm{pCO_2}$) \\
\texttt{ia\_pO2}       &  6 & $\mathrm{pO_2}$ \\
\texttt{ia\_pO2\_18O}  &  7 & $\mathrm{^{18}O}$ ($\mathrm{pO_2}$) \\
\texttt{ia\_pN2}       &  8 & $\mathrm{pN_2}$ \\
\texttt{ia\_pN2\_15N}  &  9 & $\mathrm{^{15}N}$ ($\mathrm{pN_2}$) \\
\texttt{ia\_pCH4}      & 10 & $\mathrm{pCH_4}$ \\
\texttt{ia\_pCH4\_13C} & 11 & $\mathrm{^{13}C}$ ($\mathrm{pCH_4}$) \\
\texttt{ia\_pCH4\_14C} & 12 & $\mathrm{^{14}C}$ ($\mathrm{pCH_4}$) \\
\texttt{ia\_pSF6}      & 13 & Halo-carbon \\
\texttt{ia\_pN2O}      & 14 & $\mathrm{pN_2}$ \\
\texttt{ia\_pN2O\_15N} & 15 & $\mathrm{^{15}N}$ ($\mathrm{pN_2}$) \\
\texttt{ia\_pH2S}      & 16 & $\mathrm{pH_2S}$ \\
\texttt{ia\_pH2S\_34S} & 17 & $\mathrm{pH_2S}$ \\
\texttt{ia\_pCFC11}    & 18 & Halo-carbon \\
\texttt{ia\_pCFC12}    & 19 & Halo-carbon
\end{tabular}
\end{center}

Occurrences:
\begin{center}
\begin{tabular}{lccccc}
  \textbf{File} & \textbf{Count} & \textbf{\texttt{ias}} &
  \textbf{Rename} & \textbf{Alloc} & \textbf{Check} \\
  \texttt{atchem/atchem.f90}               &  6 & Yes &  \\
  \texttt{atchem/atchem\_box.f90}          & 29 & Yes &  \\
  \texttt{atchem/atchem\_data.f90}         &  8 & Yes &  \\
  \texttt{biogem/biogem\_box.f90}          & 22 & Yes &  \\
  \texttt{biogem/biogem\_data\_netCDF.f90} & 18 & Yes &  \\
  \texttt{biogem/biogem.f90}               & 71 & Yes &  \\
  \texttt{biogem/biogem\_data\_ascii.f90}  & 22 & Yes &  \\
  \texttt{biogem/biogem\_data.f90}         &  9 & Yes &  \\
  \texttt{gemlite/gemlite.f90}             & 14 & Yes &  \\
  \texttt{rokgem/rokgem\_data\_netCDF.f90} &  1 & Yes &  \\
  \texttt{rokgem/rokgem\_box.f90}          & 27 & Yes &  \\
  \texttt{common/gem\_carbchem.f90}        &  2 & Yes &  \\
  \texttt{common/gem\_cmn.f90}             & 20 & Yes &  \\
  \texttt{common/gem\_util.f90}            & 38 & Yes &  \\
\end{tabular}
\end{center}

\newpage
\subsubsection{Index mapping}

Arrays defined using \texttt{n\_atm\_all} (\texttt{+} means should be
able to switch to \texttt{ia\_...} indexing without problems,
\texttt{?} means unsure, \texttt{X} means potential problems,
\texttt{-} means that this array \emph{should} be dimensioned as
\texttt{n\_atm\_all}, \texttt{R} means replace with an equivalent
array dimensioned as \texttt{n\_atm} and set up appropriately):

\begin{verbatim}
atchem.f90 (initialise_atchem):
+  ALLOCATE(atm(n_atm_all,n_i,n_j),STAT=alloc_error)
+  ALLOCATE(fatm(n_atm_all,n_i,n_j),STAT=alloc_error)
+  ALLOCATE(atm_slabbiosphere(n_atm_all,n_i,n_j),STAT=alloc_error)

atchem.f90 (step_atchem):
+  REAL,DIMENSION(n_atm_all)::loc_atm_tot
+  REAL,DIMENSION(n_atm_all,n_i,n_j)::locij_fatm
+  REAL,DIMENSION(n_atm_all)::loc_fracdecay_atm

atchem_box.f90 (sub_calc_terrCO2exchange):
+  REAL,DIMENSION(n_atm_all),intent(inout)::dum_fatm

atchem_box.f90 (sub_calc_wetlands_CH4):
+  REAL,DIMENSION(n_atm_all),intent(inout)::dum_fatm

atchem_box.f90 (sub_calc_generate_14C):
+  REAL,DIMENSION(n_atm_all),intent(inout)::dum_fatm

atchem_lib.f90 (module):
-  REAL,DIMENSION(n_atm_all)::atm_init

atchem_data.f90 (sub_data_load_rst):
X  integer,DIMENSION(n_atm_all)::loc_conv_iselected_ia

genie_global.f90 (allocate_genie_global):
+  ALLOCATE(genie_sfcatm(n_atm_all,ilon1_atm,ilat1_atm),STAT=status)
+  ALLOCATE(genie_sfxsumatm(n_atm_all,ilon1_atm,ilat1_atm),STAT=status)
+  ALLOCATE(genie_sfcatm1(n_atm_all,ilon1_ocn,ilat1_ocn),STAT=status)
+  ALLOCATE(genie_sfxatm1(n_atm_all,ilon1_ocn,ilat1_ocn),STAT=status)
+  ALLOCATE(genie_sfcatm_lnd(n_atm_all,ilon1_lnd,ilat1_lnd),STAT=status)
+  ALLOCATE(genie_sfxatm_lnd(n_atm_all,ilon1_lnd,ilat1_lnd),STAT=status)
+  ALLOCATE(genie_sfxsumatm1_gem(n_atm_all,ilon1_ocn,ilat1_ocn),STAT=status)
+  ALLOCATE(genie_atm1(n_atm_all,ilon1_atm,ilat1_atm),STAT=status)

biogem.f90 (fun_calc_ocnatm_flux):
+  REAL,dimension(n_atm_all)::fun_calc_ocnatm_flux
+  REAL,dimension(n_atm_all)::loc_focnatm,loc_fatmocn
+  REAL,dimension(n_atm_all)::loc_dflux

biogem_lib.f90 (module):
?  REAL,DIMENSION(n_atm_all)::par_atm_force_scale_time
?  REAL,DIMENSION(n_atm_all)::par_atm_force_scale_val
?  LOGICAL, DIMENSION(n_atm_all) :: ocnatm_airsea_eqm
?  REAL,DIMENSION(n_atm_all)::int_ocnatm_sig
?  REAL,DIMENSION(n_atm_all)::int_focnatm_sig
?  REAL,DIMENSION(n_atm_all)::int_diag_airsea_sig
?  REAL,DIMENSION(n_atm_all)::int_diag_forcing_sig
?  REAL,DIMENSION(n_atm_all,2,n_data_max)::force_restore_atm_sig
?  REAL,DIMENSION(n_atm_all)::force_restore_atm_sig_x
?  REAL,DIMENSION(n_atm_all)::force_restore_atm_tconst
?  INTEGER,DIMENSION(n_atm_all,2)::force_restore_atm_sig_i
?  LOGICAL,DIMENSION(n_atm_all)::force_restore_atm_select
?  REAL,DIMENSION(n_atm_all,2,n_data_max)::force_flux_atm_sig
?  REAL,DIMENSION(n_atm_all)::force_flux_atm_sig_x
?  INTEGER,DIMENSION(n_atm_all,2)::force_flux_atm_sig_i
?  LOGICAL,DIMENSION(n_atm_all)::force_flux_atm_select
?  LOGICAL,DIMENSION(n_atm_all)::force_flux_atm_scale
?  integer,DIMENSION(n_atm_all)::force_atm_uniform
?  integer,DIMENSION(n_atm_all)::force_atm_point_i
?  integer,DIMENSION(n_atm_all)::force_atm_point_j

rokgem_box.f90 (sub_glob_avg_weath):
+  REAL :: loc_force_flux_weather_a(n_atm_all)
+  REAL :: loc_force_flux_weather_a_land(n_atm_all,n_i,n_j)

rokgem_box.f90 (sub_2D_weath):
+  REAL :: loc_force_flux_weather_a_land(n_atm_all,n_i,n_j)

gem_cmn.f90 (module):
-  LOGICAL,DIMENSION(n_atm_all)::atm_select
-? integer,DIMENSION(n_atm_all)::atm_type
-? integer,DIMENSION(n_atm_all)::atm_dep
-  CHARACTER(len=16),DIMENSION(n_atm_all)::string_atm
-  CHARACTER(len=128),DIMENSION(n_atm_all)::string_longname_atm
X  CHARACTER(len=16),DIMENSION(n_atm_all)::string_atm_tname
X  CHARACTER(len=128),DIMENSION(n_atm_all)::string_atm_tlname
-  CHARACTER(len=12),DIMENSION(n_atm_all)::string_atm_unit
-? REAL,DIMENSION(n_atm_all,2)::atm_mima
X  INTEGER,DIMENSION(n_atm_all)::conv_ia_lselected
X  INTEGER,DIMENSION(n_atm_all)::ia2l
X  real,DIMENSION(n_atm_all,n_ocn)::conv_ocn_atm
X  real,DIMENSION(n_ocn,n_atm_all)::conv_atm_ocn
X  integer,DIMENSION(0:n_atm_all,0:n_ocn)::conv_ocn_atm_i
X  integer,DIMENSION(0:n_ocn,0:n_atm_all)::conv_atm_ocn_i
?  REAL,DIMENSION(n_atm_all)::const_lambda_atm
-  real,dimension(4,n_atm_all)::par_Sc_coef
-  real,dimension(6,n_atm_all)::par_bunsen_coef
\end{verbatim}

Removed: \texttt{conv\_iselected\_ia}, \texttt{conv\_ia\_lselected},
\texttt{l2ia}, \texttt{ia2l} (replaced by \texttt{ia\_ias} and
\texttt{ias\_ia} index maps).


\subsubsection{Array dimension names}

Rename \texttt{n\_atm} to \texttt{n\_atm\_all} and rename
\texttt{n\_l\_atm} to \texttt{n\_atm}.  Also replace
\texttt{intrac\_atm\_max} by \texttt{n\_atm\_all} and remove the
redundant tracer count definition from \texttt{genie\_control.f90}
(adding imports of \texttt{gem\_cmn} as necessary).

\subsection{Atmospheric tracer arrays}

The tricky thing here is tracing through all the references to
different permutations of the tracer arrays in different places.  The
best way to deal with it is to do a couple of related arrays at a time
and retest.

\subsection{Other arrays}

As well as the main tracer arrays, there are some module-local arrays
that can also be trimmed down:
\begin{verbatim}
  biogem/biogem.f90:66: ALLOCATE(ocnatm_airsea_pv(n_atm_all,n_i,n_j),STAT=alloc_error)
  biogem/biogem.f90:68: ALLOCATE(ocnatm_airsea_solconst(n_atm_all,n_i,n_j),STAT=alloc_error)
  biogem/biogem.f90:98: ALLOCATE(diag_forcing(n_atm_all,n_i,n_j),STAT=alloc_error)
biogem/biogem.f90:156: ALLOCATE(force_restore_atm(n_atm_all,n_i,n_j),STAT=alloc_error)
biogem/biogem.f90:158: ALLOCATE(force_restore_atm_I(n_atm_all,n_i,n_j),STAT=alloc_error)
biogem/biogem.f90:160: ALLOCATE(force_restore_atm_II(n_atm_all,n_i,n_j),STAT=alloc_error)
biogem/biogem.f90:165: ALLOCATE(force_flux_atm(n_atm_all,n_i,n_j),STAT=alloc_error)
biogem/biogem.f90:167: ALLOCATE(force_flux_atm_I(n_atm_all,n_i,n_j),STAT=alloc_error)
biogem/biogem.f90:169: ALLOCATE(force_flux_atm_II(n_atm_all,n_i,n_j),STAT=alloc_error)
  rokgem/rokgem_box.f90:480: REAL :: loc_force_flux_weather_a_land(n_atm_all,n_i,n_j)
  rokgem/rokgem_box.f90:1426: REAL :: loc_force_flux_weather_a_land(n_atm_all,n_i,n_j)
\end{verbatim}

\subsection{Diagnosing breakages}

After the changes so far, the following test jobs are broken:

\begin{verbatim}
cover/ridgwell-schmidt-2010      [01m 05s]  [FIXED]
cover/ocean-geochem-spin-up      [01m 44s]  [FIXED]
cover/ridgwell-hargreaves-2007   [03m 01s]  [FIXED]
cover/gem-adapt-auto             [03m 02s]  [FIXED]
cover/ocean-geochem-spin-up-2    [03m 07s]  [FIXED]
cover/calcium-isotopes           [04m 57s]  [FIXED]
cover/ridgwell-schmidt-2010-mud  [08m 58s]  [FIXED]
cover/nitrogen-no3               [11m 27s]  [FIXED]
cover/eocene-ch4                 [09m 57s]  [FIXED]
cover/fe-atmos-ch4               [10m 00s]  [FIXED]

cover/simple-corg-diagen         [10m 13s]
  sedgem/fields_sedgem_2d.nc
  biogem/biogem_series_fseaair_pO2.res
  biogem/biogem_series_focnatm_pO2.res
  biogem/biogem_series_ocn_H2S.res
  biogem/fields_biogem_3d.nc
  biogem/biogem_series_focnatm_pCO2.res
  biogem/biogem_series_focnatm_pCO2_13C.res
  biogem/fields_biogem_2d.nc
  biogem/biogem_series_fseaair_pH2S.res
\end{verbatim}

\subsection{Checks}

After changing all the tracer arrays to \texttt{ALLOCATABLE} of size
\texttt{n\_atm}, the following references to \texttt{n\_atm\_all}
remain.  The unlabelled ones still require attention.

\begin{verbatim}
OK atchem/atchem_lib.f90:20: REAL,DIMENSION(n_atm_all)::atm_init
OK atchem/atchem_data.f90:98: INTEGER, DIMENSION(n_atm_all) :: dummy_ias_ia
OK biogem/biogem_lib.f90:462: REAL,DIMENSION(n_atm_all)::par_atm_force_scale_time
OK biogem/biogem_lib.f90:463: REAL,DIMENSION(n_atm_all)::par_atm_force_scale_val
?  biogem/biogem_lib.f90:787: LOGICAL, DIMENSION(n_atm_all) :: ocnatm_airsea_eqm
+  biogem/biogem_lib.f90:819: REAL,DIMENSION(n_atm_all)::int_ocnatm_sig
+  biogem/biogem_lib.f90:821: REAL,DIMENSION(n_atm_all)::int_focnatm_sig
+  biogem/biogem_lib.f90:838: REAL,DIMENSION(n_atm_all)::int_diag_airsea_sig
+  biogem/biogem_lib.f90:839: REAL,DIMENSION(n_atm_all)::int_diag_forcing_sig
+  biogem/biogem_lib.f90:918: REAL,DIMENSION(n_atm_all)::force_restore_atm_sig_x
+  biogem/biogem_lib.f90:919: REAL,DIMENSION(n_atm_all)::force_restore_atm_tconst
+  biogem/biogem_lib.f90:921: LOGICAL,DIMENSION(n_atm_all)::force_restore_atm_select
+  biogem/biogem_lib.f90:936: REAL,DIMENSION(n_atm_all)::force_flux_atm_sig_x
+  biogem/biogem_lib.f90:938: LOGICAL,DIMENSION(n_atm_all)::force_flux_atm_select
+  biogem/biogem_lib.f90:939: LOGICAL,DIMENSION(n_atm_all)::force_flux_atm_scale
+  biogem/biogem_lib.f90:951: integer,DIMENSION(n_atm_all)::force_atm_uniform
+  biogem/biogem_lib.f90:954: integer,DIMENSION(n_atm_all)::force_atm_point_i
+  biogem/biogem_lib.f90:957: integer,DIMENSION(n_atm_all)::force_atm_point_j
+  rokgem/rokgem_box.f90:478: REAL :: loc_force_flux_weather_a(n_atm_all)
OK common/gem_cmn.f90:36: LOGICAL,DIMENSION(n_atm_all)::atm_select
OK common/gem_cmn.f90:363: INTEGER, DIMENSION(n_atm_all) :: atm_type
OK common/gem_cmn.f90:367: INTEGER, DIMENSION(n_atm_all) :: atm_dep
OK common/gem_cmn.f90:372: CHARACTER(len=16), DIMENSION(n_atm_all) :: string_atm
OK common/gem_cmn.f90:376: CHARACTER(len=128), DIMENSION(n_atm_all) :: string_longname_atm
OK common/gem_cmn.f90:379: CHARACTER(len=12), DIMENSION(n_atm_all) :: string_atm_unit
OK common/gem_cmn.f90:395: INTEGER, DIMENSION(n_atm_all) :: ias_ia
OK common/gem_cmn.f90:380: REAL, DIMENSION(n_atm_all,2) :: atm_mima
\end{verbatim}
A few ``special'' arrays that it makes sense to index by the fixed
tracer IDs:
\begin{verbatim}
OK common/gem_cmn.f90:24: INTEGER,PARAMETER::n_atm_all = 19
OK common/gem_cmn.f90:412: real,DIMENSION(n_atm_all,n_ocn)::conv_ocn_atm
OK common/gem_cmn.f90:413: real,DIMENSION(n_ocn,n_atm_all)::conv_atm_ocn
OK common/gem_cmn.f90:434: integer,DIMENSION(0:n_atm_all,0:n_ocn)::conv_ocn_atm_i
OK common/gem_cmn.f90:435: integer,DIMENSION(0:n_ocn,0:n_atm_all)::conv_atm_ocn_i
OK common/gem_cmn.f90:740: real,dimension(4,n_atm_all)::par_Sc_coef
OK common/gem_cmn.f90:742: real,dimension(6,n_atm_all)::par_bunsen_coef
\end{verbatim}

\begin{verbatim}
+  biogem/biogem_lib.f90:920: INTEGER,DIMENSION(n_atm_all,2)::force_restore_atm_sig_i
+  biogem/biogem_lib.f90:937: INTEGER,DIMENSION(n_atm_all,2)::force_flux_atm_sig_i
\end{verbatim}

\begin{verbatim}
+  biogem/biogem_lib.f90:917: REAL,DIMENSION(n_atm_all,2,n_data_max)::force_restore_atm_sig
+  biogem/biogem_lib.f90:935: REAL,DIMENSION(n_atm_all,2,n_data_max)::force_flux_atm_sig
\end{verbatim}

\begin{verbatim}
OK biogem/biogem_data.f90:1832: do ias=1,n_atm_all
+  rokgem/rokgem_box.f90:921: DO k=1,n_atm_all
OK common/gem_data.f90:95: &   4,n_atm_all &
OK common/gem_data.f90:132: &   6,n_atm_all &
OK common/gem_util.f90:1290: do ia=1,n_atm_all
OK common/gem_util.f90:1299: do ia=1,n_atm_all
OK common/gem_util.f90:1719: DO ias = 1, n_atm_all
\end{verbatim}

\subsection{Diagnosing more breakages}

After completing all the atmospheric tracer changes, the following
test jobs are still broken:

\begin{verbatim}
cover/eocene-ch4

 =======================================================
  >>> Initialising BIOGEM ocean biogeochem. module ...
==2048== Invalid read of size 4
==2048==    at 0x47F4ED: __biogem_data_MOD_sub_check_par_biogem (biogem_data.f90:1889)
==2048==    by 0x44DE4E: __biogem_MOD_initialise_biogem (biogem.f90:471)
==2048==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2048==    by 0x402BDF: MAIN__ (genie.f90:31)
==2048==    by 0x405B97: main (genie.f90:7)
==2048==  Address 0x167be968 is 8 bytes before a block of size 32 alloc'd
==2048==    at 0x9FEAF90: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==2048==    by 0x4432EE: __biogem_MOD_initialise_biogem (biogem.f90:178)
==2048==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2048==    by 0x402BDF: MAIN__ (genie.f90:31)
==2048==    by 0x405B97: main (genie.f90:7)
==2048==
==2048== Invalid read of size 4
==2048==    at 0x47F762: __biogem_data_MOD_sub_check_par_biogem (biogem_data.f90:1900)
==2048==    by 0x44DE4E: __biogem_MOD_initialise_biogem (biogem.f90:471)
==2048==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2048==    by 0x402BDF: MAIN__ (genie.f90:31)
==2048==    by 0x405B97: main (genie.f90:7)
==2048==  Address 0x167beac8 is 8 bytes before a block of size 32 alloc'd
==2048==    at 0x9FEAF90: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==2048==    by 0x44444B: __biogem_MOD_initialise_biogem (biogem.f90:195)
==2048==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2048==    by 0x402BDF: MAIN__ (genie.f90:31)
==2048==    by 0x405B97: main (genie.f90:7)
==2048==
  <<< Initialisation complete
 =======================================================
 =======================================================
  >>> Initialising ATCHEM atmospheric chem. module ...
  <<< Initialisation complete
 =======================================================


\end{verbatim}

\begin{verbatim}
cover/fe-atmos-ch4

  <<< Initialisation complete
 =======================================================
 =======================================================
  >>> Initialising BIOGEM ocean biogeochem. module ...
==2046== Invalid read of size 4
==2046==    at 0x47F4ED: __biogem_data_MOD_sub_check_par_biogem (biogem_data.f90:1889)
==2046==    by 0x44DE4E: __biogem_MOD_initialise_biogem (biogem.f90:471)
==2046==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2046==    by 0x402BDF: MAIN__ (genie.f90:31)
==2046==    by 0x405B97: main (genie.f90:7)
==2046==  Address 0x1d57e0d8 is 8 bytes before a block of size 28 alloc'd
==2046==    at 0x9FEAF90: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==2046==    by 0x4432EE: __biogem_MOD_initialise_biogem (biogem.f90:178)
==2046==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2046==    by 0x402BDF: MAIN__ (genie.f90:31)
==2046==    by 0x405B97: main (genie.f90:7)
==2046==
==2046== Invalid read of size 4
==2046==    at 0x47F762: __biogem_data_MOD_sub_check_par_biogem (biogem_data.f90:1900)
==2046==    by 0x44DE4E: __biogem_MOD_initialise_biogem (biogem.f90:471)
==2046==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2046==    by 0x402BDF: MAIN__ (genie.f90:31)
==2046==    by 0x405B97: main (genie.f90:7)
==2046==  Address 0x1d57e238 is 8 bytes before a block of size 28 alloc'd
==2046==    at 0x9FEAF90: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==2046==    by 0x44444B: __biogem_MOD_initialise_biogem (biogem.f90:195)
==2046==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2046==    by 0x402BDF: MAIN__ (genie.f90:31)
==2046==    by 0x405B97: main (genie.f90:7)
==2046==
  <<< Initialisation complete
 =======================================================
 =======================================================
  >>> Initialising ATCHEM atmospheric chem. module ...
  <<< Initialisation complete

\end{verbatim}

\begin{verbatim}
cover/simple-corg-diagen

  <<< Initialisation complete
 =======================================================
 =======================================================
  >>> Initialising BIOGEM ocean biogeochem. module ...
==2047== Invalid read of size 4
==2047==    at 0x47F4ED: __biogem_data_MOD_sub_check_par_biogem (biogem_data.f90:1889)
==2047==    by 0x44DE4E: __biogem_MOD_initialise_biogem (biogem.f90:471)
==2047==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2047==    by 0x402BDF: MAIN__ (genie.f90:31)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==  Address 0x158b7198 is 8 bytes before a block of size 24 alloc'd
==2047==    at 0x9FEAF90: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==2047==    by 0x4432EE: __biogem_MOD_initialise_biogem (biogem.f90:178)
==2047==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2047==    by 0x402BDF: MAIN__ (genie.f90:31)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==
==2047== Invalid read of size 4
==2047==    at 0x47F762: __biogem_data_MOD_sub_check_par_biogem (biogem_data.f90:1900)
==2047==    by 0x44DE4E: __biogem_MOD_initialise_biogem (biogem.f90:471)
==2047==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2047==    by 0x402BDF: MAIN__ (genie.f90:31)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==  Address 0x2148efb8 is 8 bytes before a block of size 24 alloc'd
==2047==    at 0x9FEAF90: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==2047==    by 0x44444B: __biogem_MOD_initialise_biogem (biogem.f90:195)
==2047==    by 0x6FAE31: __genie_ini_wrappers_MOD_initialise_biogem_wrapper (genie_ini_wrappers.f90:72)
==2047==    by 0x402BDF: MAIN__ (genie.f90:31)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==
  <<< Initialisation complete
 =======================================================
 =======================================================
  >>> Initialising ATCHEM atmospheric chem. module ...
  <<< Initialisation complete
 =======================================================


==2047==
==2047== Conditional jump or move depends on uninitialised value(s)
==2047==    at 0xE28C578: __printf_fp (in /usr/lib/libc-2.21.so)
==2047==    by 0xE287406: vfprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2B2BE8: vsnprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2911D1: snprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xD8B41E8: write_float (write_float.def:1289)
==2047==    by 0xD8AD6CB: formatted_transfer_scalar_write (transfer.c:1764)
==2047==    by 0xD8AD6CB: formatted_transfer (transfer.c:2002)
==2047==    by 0x4A7162: __biogem_data_ascii_MOD_sub_data_save_global_av (biogem_data_ascii.f90:2148)
==2047==    by 0x41F3C5: __biogem_MOD_diag_biogem_timeslice (biogem.f90:2653)
==2047==    by 0x6FB6C6: __genie_loop_wrappers_MOD_diag_biogem_timeslice_wrapper (genie_loop_wrappers.f90:348)
==2047==    by 0x4041E9: MAIN__ (genie.f90:268)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==
==2047== Use of uninitialised value of size 8
==2047==    at 0xE28CA82: __printf_fp (in /usr/lib/libc-2.21.so)
==2047==    by 0xE287406: vfprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2B2BE8: vsnprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2911D1: snprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xD8B41E8: write_float (write_float.def:1289)
==2047==    by 0xD8AD6CB: formatted_transfer_scalar_write (transfer.c:1764)
==2047==    by 0xD8AD6CB: formatted_transfer (transfer.c:2002)
==2047==    by 0x4A7162: __biogem_data_ascii_MOD_sub_data_save_global_av (biogem_data_ascii.f90:2148)
==2047==    by 0x41F3C5: __biogem_MOD_diag_biogem_timeslice (biogem.f90:2653)
==2047==    by 0x6FB6C6: __genie_loop_wrappers_MOD_diag_biogem_timeslice_wrapper (genie_loop_wrappers.f90:348)
==2047==    by 0x4041E9: MAIN__ (genie.f90:268)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==
==2047== Use of uninitialised value of size 8
==2047==    at 0xE284948: __mpn_lshift (in /usr/lib/libc-2.21.so)
==2047==    by 0xE28CA86: __printf_fp (in /usr/lib/libc-2.21.so)
==2047==    by 0xE287406: vfprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2B2BE8: vsnprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2911D1: snprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xD8B41E8: write_float (write_float.def:1289)
==2047==    by 0xD8AD6CB: formatted_transfer_scalar_write (transfer.c:1764)
==2047==    by 0xD8AD6CB: formatted_transfer (transfer.c:2002)
==2047==    by 0x4A7162: __biogem_data_ascii_MOD_sub_data_save_global_av (biogem_data_ascii.f90:2148)
==2047==    by 0x41F3C5: __biogem_MOD_diag_biogem_timeslice (biogem.f90:2653)
==2047==    by 0x6FB6C6: __genie_loop_wrappers_MOD_diag_biogem_timeslice_wrapper (genie_loop_wrappers.f90:348)
==2047==    by 0x4041E9: MAIN__ (genie.f90:268)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==
==2047== Use of uninitialised value of size 8
==2047==    at 0xE28494B: __mpn_lshift (in /usr/lib/libc-2.21.so)
==2047==    by 0xE28CA86: __printf_fp (in /usr/lib/libc-2.21.so)
==2047==    by 0xE287406: vfprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2B2BE8: vsnprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xE2911D1: snprintf (in /usr/lib/libc-2.21.so)
==2047==    by 0xD8B41E8: write_float (write_float.def:1289)
==2047==    by 0xD8AD6CB: formatted_transfer_scalar_write (transfer.c:1764)
==2047==    by 0xD8AD6CB: formatted_transfer (transfer.c:2002)
==2047==    by 0x4A7162: __biogem_data_ascii_MOD_sub_data_save_global_av (biogem_data_ascii.f90:2148)
==2047==    by 0x41F3C5: __biogem_MOD_diag_biogem_timeslice (biogem.f90:2653)
==2047==    by 0x6FB6C6: __genie_loop_wrappers_MOD_diag_biogem_timeslice_wrapper (genie_loop_wrappers.f90:348)
==2047==    by 0x4041E9: MAIN__ (genie.f90:268)
==2047==    by 0x405B97: main (genie.f90:7)
==2047==
\end{verbatim}


\begin{verbatim}
sedgem/fields_sedgem_2d.nc
biogem/fields_biogem_3d.nc
biogem/biogem_series_fseaair_pO2.res
biogem/biogem_series_focnatm_pO2.res
biogem/biogem_series_ocn_H2S.res
biogem/biogem_series_focnatm_pCO2.res
biogem/biogem_series_focnatm_pCO2_13C.res
biogem/fields_biogem_2d.nc
biogem/biogem_series_fseaair_pH2S.res
\end{verbatim}

%----------------------------------------------------------------------
\section{Sediment tracers}

\subsection{Step 1: name changes and indexing setup}

\begin{enumerate}
  \item{Global replace of \texttt{n\_sed} with \texttt{nt\_sed\_all}.}
  \item{Global replace of \texttt{n\_l\_sed} with \texttt{nt\_sed}.}
  \item{Global replace of \texttt{is\_...} tracer indexes with
    \texttt{iss\_...}.}
  \item{Add \texttt{is\_...} variables and set up initialisation.}
  \item{Indexing for \texttt{string\_sed} and friends.}
  \item{Global replace \texttt{intrac\_sed\_max} with \texttt{nt\_sed\_all}.}
\end{enumerate}

\subsection{Step 2: array definitions}

\newpage
\begin{small}
\begin{verbatim}
wrappers/genie_global.f90:
14:   USE gem_cmn, ONLY: nt_sed_all
1045: ALLOCATE(genie_sfcsed(nt_sed_all,ilon1_sed,ilat1_sed),STAT=status)
1047: ALLOCATE(genie_sfxsumsed(nt_sed_all,ilon1_sed,ilat1_sed),STAT=status)
1049: ALLOCATE(genie_sfxsumsed1(nt_sed_all,ilon1_ocn,ilat1_ocn),STAT=status)
1051: ALLOCATE(genie_sfcsed1(nt_sed_all,ilon1_ocn,ilat1_ocn),STAT=status)
1053: ALLOCATE(genie_sfxsed1(nt_sed_all,ilon1_ocn,ilat1_ocn),STAT=status)

wrappers/genie_loop_wrappers.f90:
176:  & nt_sed_all, ilon1_ocn, ilat1_ocn, ilon1_sed, ilat1_sed, &
190:  CALL cpl_flux_sedsed1(nt_sed_all, ilon1_ocn, ilat1_ocn, &

sedgem/sedgem_data.f90:
213:  integer,DIMENSION(nt_sed_all)::loc_is_iss
664:  do is=1,nt_sed_all
982:  REAL,DIMENSION(nt_sed_all)::loc_sed
1121: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed_coretop
1122: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed_preservation
1127: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_fsed
1128: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_fdis
1708: ALLOCATE(loc_sed_save(nt_sed_all,n_i,n_j,0:n_sed_tot),STAT=alloc_error)
2072: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed_coretop
2073: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed_preservation

sedgem/sedgem_data_netCDF.f90:
281:  real,dimension(nt_sed_all)::loc_sed
1231: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed_coretop
1232: REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed_preservation
1425: DO is=1,nt_sed_all
1548: DO is=1,nt_sed_all

sedgem/sedgem.f90:
69:   ALLOCATE(sed(nt_sed_all,n_i,n_j,n_sed_tot),STAT=alloc_error)
71:   ALLOCATE(sed_top(nt_sed_all,n_i,n_j),STAT=alloc_error)
77:   ALLOCATE(sed_fsed(nt_sed_all,n_i,n_j),STAT=alloc_error)
79:   ALLOCATE(sed_fdis(nt_sed_all,n_i,n_j),STAT=alloc_error)
93:   ALLOCATE(sed_fsed_OLD(nt_sed_all,n_i,n_j),STAT=alloc_error)
95:   ALLOCATE(sed_fdis_OLD(nt_sed_all,n_i,n_j),STAT=alloc_error)
247:  REAL,DIMENSION(nt_sed_all)::loc_fracdecay_sed
255:  real,DIMENSION(nt_sed_all,n_i,n_j)::loc_sfxsumsed_OLD

sedgem/sedgem_box.f90:
78:   REAL,DIMENSION(nt_sed_all)::loc_new_sed
79:   REAL,DIMENSION(nt_sed_all)::loc_dis_sed
80:   REAL,DIMENSION(nt_sed_all)::loc_exe_sed
635:  do is=1,nt_sed_all
639:  do is=1,nt_sed_all
643:  do is=1,nt_sed_all
735:  REAL,DIMENSION(nt_sed_all)::loc_new_sed
736:  REAL,DIMENSION(nt_sed_all)::loc_dis_sed
737:  REAL,DIMENSION(nt_sed_all)::loc_exe_sed
1091: do is=1,nt_sed_all
1095: do is=1,nt_sed_all
1099: do is=1,nt_sed_all
1156: REAL,DIMENSION(nt_sed_all)::loc_new_sed
1157: REAL,DIMENSION(nt_sed_all)::loc_dis_sed
1158: REAL,DIMENSION(nt_sed_all)::loc_exe_sed
1563: REAL,INTENT(inout),DIMENSION(nt_sed_all)::dum_sed_dis
1564: REAL,INTENT(in),DIMENSION(nt_sed_all)::dum_sed_new
1565: REAL,INTENT(in),DIMENSION(nt_sed_all)::dum_sed_top
1737: REAL,INTENT(inout),DIMENSION(nt_sed_all)::dum_sed_dis
1738: REAL,INTENT(in),DIMENSION(nt_sed_all)::dum_sed_new
1739: REAL,INTENT(in),DIMENSION(nt_sed_all)::dum_sed_top
1940: REAL,INTENT(inout),DIMENSION(nt_sed_all,0:par_n_sed_mix)::dum_sed
1941: REAL,INTENT(inout),DIMENSION(nt_sed_all)::dum_sed_top

sedgem/sedgem_lib.f90:
322:  real,DIMENSION(nt_sed_all)::conv_sed_cm3_mol
323:  real,DIMENSION(nt_sed_all)::conv_sed_mol_cm3
324:  real,DIMENSION(nt_sed_all)::conv_sed_cm3_g
325:  real,DIMENSION(nt_sed_all)::conv_sed_g_cm3
326:  real,DIMENSION(nt_sed_all)::conv_sed_mask
397:  REAL,INTENT(in),DIMENSION(nt_sed_all)::dum_sed
412:  REAL,INTENT(in),DIMENSION(nt_sed_all)::dum_sed
496:  REAL,DIMENSION(nt_sed_all,n_i,n_j)::fun_sed_coretop
501:  REAL,DIMENSION(nt_sed_all,n_i,n_j)::loc_sed

biogem/biogem_box.f90:
361:  real,dimension(nt_sed_all,n_k)::loc_bio_part_DOM
362:  real,dimension(nt_sed_all,n_k)::loc_bio_part_RDOM
1528: real,dimension(nt_sed_all,n_k)::loc_bio_part
2299: real,dimension(nt_sed_all,n_k)::loc_bio_part
3503: real,dimension(nt_sed_all,n_i,n_j,n_k)::loc_bio_part

biogem/biogem.f90:
72:   ALLOCATE(bio_part(nt_sed_all,n_i,n_j,n_k),STAT=alloc_error)
76:   ALLOCATE(bio_settle(nt_sed_all,n_i,n_j,n_k),STAT=alloc_error)
78:   ALLOCATE(bio_part_red(nt_sed_all,nt_sed_all,n_i,n_j),STAT=alloc_error)
109:  ALLOCATE(int_bio_part_timeslice(nt_sed_all,n_i,n_j,n_k),STAT=alloc_error)
111:  ALLOCATE(int_bio_settle_timeslice(nt_sed_all,n_i,n_j,n_k),STAT=alloc_error)
129:  ALLOCATE(int_sfcsed1_timeslice(nt_sed_all,n_i,n_j),STAT=alloc_error)
131:  ALLOCATE(int_focnsed_timeslice(nt_sed_all,n_i,n_j),STAT=alloc_error)
200:  ALLOCATE(force_flux_sed(nt_sed_all,n_i,n_j),STAT=alloc_error)
202:  ALLOCATE(force_flux_sed_I(nt_sed_all,n_i,n_j),STAT=alloc_error)
204:  ALLOCATE(force_flux_sed_II(nt_sed_all,n_i,n_j),STAT=alloc_error)
593:  REAL,DIMENSION(nt_sed_all,n_i,n_j,n_k)::locijk_fpart
603:  REAL,DIMENSION(nt_sed_all,n_i,n_j)::locij_focnsed
608:  REAL,DIMENSION(nt_sed_all)::loc_fracdecay_sed
2417: REAL,DIMENSION(nt_sed_all,n_i,n_j)::locij_focnsed
2701: REAL,DIMENSION(nt_sed_all,n_i,n_j)::locij_focnsed

biogem/biogem_lib.f90:
820:  REAL,DIMENSION(nt_sed_all)::int_fexport_sig
822:  REAL,DIMENSION(nt_sed_all)::int_focnsed_sig
834:  REAL,DIMENSION(nt_sed_all)::int_ocnsed_sig
943:  REAL,DIMENSION(nt_sed_all,2,n_data_max)::force_flux_sed_sig
944:  REAL,DIMENSION(nt_sed_all)::force_flux_sed_sig_x
945:  INTEGER,DIMENSION(nt_sed_all,2)::force_flux_sed_sig_i
946:  LOGICAL,DIMENSION(nt_sed_all)::force_flux_sed_select
947:  LOGICAL,DIMENSION(nt_sed_all)::force_flux_sed_scale
953:  integer,DIMENSION(nt_sed_all)::force_sed_uniform
956:  integer,DIMENSION(nt_sed_all)::force_sed_point_i
959:  integer,DIMENSION(nt_sed_all)::force_sed_point_j
1266: REAL,DIMENSION(nt_sed_all,n_i,n_j,n_k)::fun_lib_conv_vsedTOsed

biogem/biogem_data.f90:
449:  integer,DIMENSION(nt_sed_all)::loc_is_iss
729:  real,dimension(1:n_ocn,1:nt_sed_all)::loc_conv_sed_ocn
730:  integer,dimension(0:n_ocn,0:nt_sed_all)::loc_tracerrelationships
1914: do is=1,nt_sed_all
1971: do is=1,nt_sed_all

common/gem_cmn.f90:
26:   INTEGER,PARAMETER::nt_sed_all = 79
38:   LOGICAL,DIMENSION(nt_sed_all)::sed_select
447:  INTEGER, DIMENSION(nt_sed_all) :: sed_type
451:  INTEGER, DIMENSION(nt_sed_all) :: sed_dep
455:  CHARACTER(len=16), DIMENSION(nt_sed_all) :: string_sed
459:  CHARACTER(len=128), DIMENSION(nt_sed_all) :: string_longname_sed
467:  CHARACTER(len=12), DIMENSION(nt_sed_all) :: string_sed_unit
468:  REAL, DIMENSION(nt_sed_all,2) :: sed_mima
479:  INTEGER, DIMENSION(nt_sed_all) :: iss_is
490:  real,DIMENSION(nt_sed_all,n_ocn)::conv_ocn_sed
491:  real,DIMENSION(n_ocn,nt_sed_all)::conv_sed_ocn
494:  real,DIMENSION(nt_sed_all,n_ocn)::conv_DOM_POM
495:  real,DIMENSION(n_ocn,nt_sed_all)::conv_POM_DOM
496:  real,DIMENSION(nt_sed_all,n_ocn)::conv_RDOM_POM
497:  real,DIMENSION(n_ocn,nt_sed_all)::conv_POM_RDOM
498:  real,DIMENSION(n_ocn,nt_sed_all)::conv_sed_ocn_N
499:  real,DIMENSION(n_ocn,nt_sed_all)::conv_sed_ocn_S
500:  real,DIMENSION(n_ocn,nt_sed_all)::conv_sed_ocn_meth
512:  integer,DIMENSION(0:nt_sed_all,0:n_ocn)::conv_ocn_sed_i
513:  integer,DIMENSION(0:n_ocn,0:nt_sed_all)::conv_sed_ocn_i
516:  integer,DIMENSION(0:nt_sed_all,0:n_ocn)::conv_DOM_POM_i
517:  integer,DIMENSION(0:n_ocn,0:nt_sed_all)::conv_POM_DOM_i
518:  integer,DIMENSION(0:nt_sed_all,0:n_ocn)::conv_RDOM_POM_i
519:  integer,DIMENSION(0:n_ocn,0:nt_sed_all)::conv_POM_RDOM_i
520:  integer,DIMENSION(0:n_ocn,0:nt_sed_all)::conv_sed_ocn_i_N
521:  integer,DIMENSION(0:n_ocn,0:nt_sed_all)::conv_sed_ocn_i_S
522:  integer,DIMENSION(0:n_ocn,0:nt_sed_all)::conv_sed_ocn_i_meth
784:  REAL,DIMENSION(nt_sed_all)::const_lambda_sed

common/initialise_gem.f90
62:   do is=1,nt_sed_all

common/gem_util.f90:
1268: do is=1,nt_sed_all
1277: do is=1,nt_sed_all
1312: do is=1,nt_sed_all
1321: do is=1,nt_sed_all
1334: do is=1,nt_sed_all
1343: do is=1,nt_sed_all
1355: do is=1,nt_sed_all
1367: do is=1,nt_sed_all
1379: do is=1,nt_sed_all
1399: real,dimension(1:n_ocn,1:nt_sed_all),INTENT(in)::dum_conv_sed_ocn
1403: integer,dimension(0:n_ocn,0:nt_sed_all)::fun_recalc_tracerrelationships_i
1409: integer,dimension(0:n_ocn,0:nt_sed_all)::loc_conv_sed_ocn_i
1418: do is=1,nt_sed_all
1443: real,dimension(n_ocn,nt_sed_all),INTENT(in)::dum_sed_ocn
1461: do is=1,nt_sed_all
1483: integer,dimension(0:n_ocn,0:nt_sed_all),INTENT(in)::dum_sed_ocn_i
1505: do is=1,nt_sed_all
1528: real,dimension(nt_sed_all,n_ocn),INTENT(in)::dum_ocn_sed
1547: do is=1,nt_sed_all
1568: integer,dimension(0:nt_sed_all,0:n_ocn),INTENT(in)::dum_ocn_sed_i
1587: do is=1,nt_sed_all
2074: do iss = 1, nt_sed_all
\end{verbatim}
\end{small}

%----------------------------------------------------------------------
\section{Ocean tracers}

\end{document}
